{% extends '@RoadizRozier/layout.html.twig' %}

{% set document_title = "edit.document.%name%"|trans({'%name%': document})|truncate_title %}

{% block title %}{{ document_title }} | {{ parent() }}{% endblock %}

{% block content %}
<section class="content-global manage-document">
    {% include '@RoadizRozier/documents/head.html.twig' with {
        document: document,
        title: document_title,
        current: 'edit',
        with_nav_bar: true,
        with_breadcrumb: true,
    } only %}

    <article>
        {% form_theme form '@RoadizRozier/forms.html.twig' %}
        {{ form_start(form, { attr: {id: "edit-document-form"}}) }}
            {% if document.isLocal %}
                {% if not document|exists %}
                    <p class="uk-alert uk-alert-danger"><i class="uk-icon-error"></i> {% trans %}current.document.file.does.not.exist{% endtrans %}</p>
                {% elseif not document.filename %}
                    <p class="uk-alert uk-alert-warning"><i class="uk-icon-error"></i> {% trans %}document.is_only_external{% endtrans %}</p>
                {% endif %}

                <div class="rz-document-edit">
                    <div class="rz-document-edit__first-column{% if document.private %} rz-document-edit__first-column--private{% endif %}">
                        {% if not document.private %}
                            {% if (document.image or document.svg or document.video or document.audio or document.pdf) and document.isEmbed == false %}
                                {% set options = {
                                    'width': document.imageWidth,
                                    'height': document.imageHeight,
                                } %}
                                {% if document.pdf %}
                                    {% set figureStyle = {
                                        style: "aspect-ratio: 750/700;"
                                    } %}
                                    {% set options = options|merge({'embed': true}) %}
                                {% endif %}
                                {% if document.mimeType == 'image/gif' %}
                                    {% set options = options|merge({noProcess:true}) %}
                                {% endif %}
                                <figure {% for attr, value in figureStyle %} {{ attr }}="{{ value }}" {% endfor %}>
                                    {{ document|display(options) }}
                                </figure>
                            {% endif %}

                            {% if document.isEmbed %}
                                <figure style="aspect-ratio: {{ document.imageWidth }}/{{ document.imageHeight }};">
                                    {{ document|display({
                                        embed: true,
                                        autoplay: false,
                                        controls: true,
                                        fullscreen: true,
                                    }) }}
                                </figure>
                            {% endif %}
                        {% else %}
                            <div class="rz-message rz-message--error rz-message--filled">
                                <p class="rz-message__text">
                                    {% trans %}current.document.is.private.you.cannot.preview.it{% endtrans %}
                                </p>
                            </div>
                        {% endif %}
                    </div>
                    <div class="rz-document-edit__second-column rz-form__field-list">
                        {{ form_row(form.filename) }}
                        {{ form_row(form.mimeType) }}
                        {{ form_row(form.newDocument) }}
                        {% embed '@RoadizRozier/includes/rz_table.html.twig' with {
                            bordered: true,
                            attributes: {
                                class: 'rz-table--td-ellipsis',
                                style: '--rz-table-cell-max-width: 30ch',
                            }
                        } %}
                            {% block tbody_content %}
                                {% import "@RoadizRozier/macros/rz_button.html.twig" as rz_button %}
                                {% if not document.private and document.filename %}
                                    <tr><th>{% trans %}document.relative_url{% endtrans %}</th><td>{{ document|url}}</td></tr>
                                    <tr><th>{% trans %}document.absolute_url{% endtrans %}</th><td>{{ document|url({absolute:true}) }}</td></tr>
                                    <tr><th>{% trans %}document.unprocessed_url{% endtrans %}</th><td>{{ document|url({noProcess:true}) }}</td></tr>
                                {% endif %}
                                {% if document.isEmbed and document|embedFinder %}
                                    <tr>
                                        <th>{% trans %}document.source_url{% endtrans %}</th>
                                        {% set content = (document|embedFinder).source %}
                                        <td class="rz-table__cell--ellipsis" title="{{ content }}">{{ content }}</td>
                                    </tr>
                                {% endif %}
                                {% if document.filesize > 0 %}
                                    <tr><th>{% trans %}document.filesize{% endtrans %}</th><td>{{ document.filesize|formatBytes }}</td></tr>
                                {% endif %}
                                {% set infos = {} %}
                                {% if document.isProcessable or document.svg %}
                                    {% set infos = infos|merge({
                                        'width': document.imageWidth ~ 'px',
                                        'height': document.imageHeight ~ 'px'
                                    }) %}
                                {% endif %}
                                {% if document.mediaDuration > 0 %}
                                    {% set infos = infos|merge({
                                        'duration': document.mediaDuration ~ ' sec'
                                    }) %}
                                {% endif %}
                                {% for key, info in infos %}
                                    <tr><th>{{ ('document.' ~ key)|trans }}</th><td>{{ info }}</td></tr>
                                {% endfor %}
                                <tr>
                                    <th>{% trans %}created.at{% endtrans %}</th>
                                    <td>{{ document.createdAt|format_datetime('long', locale=app.request.locale) }}</td>
                                </tr>
                                <tr>
                                    <th>{% trans %}updated.at{% endtrans %}</th>
                                    <td>{{ document.updatedAt|format_datetime('long', locale=app.request.locale) }}</td>
                                </tr>
                                {% if document.Local %}
                                    <tr>
                                        <th>{% trans %}document.filepath{% endtrans %}</th>
                                        <td>{{ document|path }}</td>
                                    </tr>
                                {% endif %}
                                {% if not document.private and document.Local %}
                                    <tr>
                                        <th>{% trans %}document.public_url{% endtrans %}</th>
                                        <td>{{ document|url({noProcess: true}) }}</td>
                                    </tr>
                                {% endif %}
                                {% if rawDocument and rawDocument.Local %}
                                    <tr>
                                        <th>{% trans %}document.raw_document{% endtrans %}</th>
                                        <td>
                                            {{ rz_button.root({
                                                label: 'download.raw.document'|trans,
                                                icon: 'rz-icon-ri--download-line',
                                                emphasis: 'tertiary',
                                                attributes: {
                                                    href: path('documentsDownloadPage', { documentId: rawDocument.id }),
                                                },
                                            }) }}
                                        </td>
                                    </tr>
                                {% endif %}
                                {% if document.original %}
                                    <tr>
                                        <th>{% trans %}original.document{% endtrans %}</th>
                                        <td>
                                            <p>{{ document.original.filename }}</p>
                                            <p><a
                                                    href="{{ path('documentsEditPage', { documentId: document.original.id}) }}"
                                                    class="uk-button uk-button-small rz-no-ajax-link">
                                                    <i class="uk-icon-rz-link"></i>
                                                    {% trans %}see.original.document{%- endtrans -%}
                                                </a>
                                            </p>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endblock %}
                        {% endembed %}
                    </div>
                </div>
            {% endif %}

            <div class="rz-form__field-list">
                {{ form_rest(form) }}
            </div>
        {% import "@RoadizRozier/macros/rz_actions_menu.html.twig" as actions_menu %}
        {{ actions_menu.saveItem('#edit-document-form') }}
        {{ form_end(form, { render_rest: false }) }}
    </article>

    {% include '@RoadizRozier/documents/actionsMenu.html.twig' %}
</section>
{% endblock %}
