import{S as p}from"./sortable.core.esm-Bjnw44Mn.js";import{f,a as c}from"./main-DvSyKddi.js";import"./vue-BqDQd3Vv.js";import"./jquery-DmndgEMa.js";class S extends HTMLElement{constructor(){super(),this.rootNode=null,this.sortables=[],this.onSortableChange=this.onSortableChange.bind(this),this.onCommand=this.onCommand.bind(this)}get group(){return this.getAttribute("group")||"tree"}get positionRoute(){const t=this.getAttribute("data-position-route");return t||(!window.RozierConfig||!window.RozierConfig.routes?null:this.entityType==="node"?window.RozierConfig.routes.nodesPositionAjax:this.entityType==="tag"?window.RozierConfig.routes.tagPositionAjax:this.entityType==="folder"?window.RozierConfig.routes.foldersPositionAjax:null)}get entityType(){return this.getAttribute("data-entity-type")}get isSortable(){return this.getAttribute("data-is-sortable")!=="false"&&!!this.positionRoute}get expandedStateKey(){const t="collapsed.rz_tree",e=this.getAttribute("data-tree-id")||this.id||"root";return`${t}.${e}`}connectedCallback(){this.rootNode=this.querySelector('[role="tree"]'),this.isSortable&&this.initSortable(),this.syncCollapsedState(),this.bindExpandButtons(),this.addEventListener("command",this.onCommand)}disconnectedCallback(){this.removeEventListener("command",this.onCommand),this.destroySortable()}onCommand(t){switch(t.command){case"--toggle-children":this.onToggleChildren(t);break;case"--quick-add-child-node":this.onQuickAddNode(t);break}}get rootList(){return this.querySelector(".rz-tree__list")}getRootLinkedTypes(){const t=this.rootList;if(!t)return[];const e=t.getAttribute("data-linked-types");if(!e)return[];try{return JSON.parse(e)}catch{return[]}}getRootNodeId(){const t=this.rootList;if(!t)return null;const e=t.getAttribute("data-parent-id");if(!e)return null;const n=parseInt(e,10);return Number.isNaN(n)?null:n}getRootTranslationId(){const t=this.rootList;if(!t)return null;const e=t.getAttribute("data-translation-id");if(!e)return null;const n=parseInt(e,10);return Number.isNaN(n)?null:n}async quickAddNode(t,e,n){const s=await fetch(window.RozierConfig.routes.nodesGenerateAndAddNodeAction,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({csrfToken:window.RozierConfig.ajaxToken,nodeTypeName:t,parentNodeId:e.toString(),translationId:n?n.toString():""})});if(!s.ok)throw s;return await s.json()}async onQuickAddNode(t){t.preventDefault();const e=t.source;if(!e)return;const n=e.getAttribute("data-children-node-type"),s=parseInt(e.getAttribute("data-children-parent-node")||"",10),o=e.getAttribute("data-translation-id"),r=o?parseInt(o,10):null;if(!(!n||Number.isNaN(s)||s<=0))try{await this.quickAddNode(n,s,r),window.dispatchEvent(new CustomEvent("requestMainTreeRefresh")),window.dispatchEvent(new CustomEvent("requestMessagesRefresh")),await this.refreshNodeTree()}catch(d){await this.pushRequestError(d)}}async fetchNodeTree(t,e,n=null){const s=new URLSearchParams({_token:window.RozierConfig.ajaxToken,_action:"requestNodeTree",parentNodeId:t.toString(),translationId:n?n.toString():""});e.forEach((d,i)=>{s.append(`linkedTypes[${i}]`,d)});const o=window.RozierConfig.routes.nodesTreeAjax+"?"+s.toString(),r=await fetch(o,{method:"GET",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(!r.ok)throw r;return await r.json()}async refreshNodeTree(){const t=this.getRootNodeId();if(!t){console.log("No node-tree available.");return}const e=this.getRootLinkedTypes(),n=this.getRootTranslationId();window.dispatchEvent(new CustomEvent("requestLoaderShow"));try{const s=await this.fetchNodeTree(t,e,n);if(typeof s.nodeTree<"u"){const o=document.createElement("div");o.innerHTML=s.nodeTree;const r=o.querySelector("rz-tree");if(await f(this),r){const d=this.getAttribute("class");if(d){const i=r.getAttribute("class")||"",u=new Set(`${i} ${d}`.trim().split(/\s+/));r.setAttribute("class",Array.from(u).join(" "))}Array.from(this.attributes).forEach(i=>{i.name!=="class"&&r.setAttribute(i.name,i.value)}),this.replaceWith(r),await c(r)}else this.innerHTML=s.nodeTree,this.rootNode=this.querySelector('[role="tree"]'),this.bindExpandButtons(),await c(this);window.dispatchEvent(new CustomEvent("requestNestablesInit")),window.dispatchEvent(new CustomEvent("requestBindMainTrees")),window.dispatchEvent(new CustomEvent("requestAjaxLinkBind"))}}catch(s){await this.pushRequestError(s)}finally{window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}async pushRequestError(t){let e="An unexpected error occurred.";try{if(t&&typeof t.json=="function"){const n=await t.json();e=n?.error_message||n?.detail||e}else if(t&&typeof t.responseText=="string")e=JSON.parse(t.responseText)?.error_message||e;else if(t&&typeof t=="object"){const n=t;e=n.error_message||n.detail||e}}catch(n){console.error("Error parsing error response",n)}window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:e,status:"danger"}}))}onToggleChildren(t){const e=t.source,s=!(e.getAttribute("aria-expanded")==="true");e.setAttribute("aria-expanded",s.toString());const o=e.closest("li.rz-tree__item");o&&this.updateCollapsedState(o,s)}bindExpandButtons(){const t=this.querySelectorAll(".rz-tree__item__expand-button");t.length&&t.forEach(e=>{e.hasAttribute("commandfor")||e.setAttribute("commandfor",this.id)})}initSortable(){const t=this?.querySelectorAll(".rz-tree__list");if(t)for(let e=0;e<t.length;e++)this.sortables.push(new p(t[e],{group:this.group,animation:150,filter:".rz-tree__item--locked",handle:".rz-tree__item__handle",chosenClass:"rz-tree__item--chosen",dragClass:"rz-tree__item--drag",ghostClass:"rz-tree__item--ghost",onAdd:this.onSortableChange,onUpdate:this.onSortableChange,onRemove:()=>!1}))}syncCollapsedState(){const t=this.getExpandedIds();t.length&&t.forEach(e=>{const n=this.querySelector(`.rz-tree__item[data-entity-id="${e}"]`);if(!n)return;n.querySelector(".rz-tree__item__expand-button")?.setAttribute("aria-expanded","true")})}updateCollapsedState(t,e){const n=this.getExpandedIds(),s=this.getEntityId(t);if(!s){console.warn("Entity ID not found for item",t);return}if(e&&!n.includes(s))n.push(s);else if(!e){const o=n.indexOf(s);o>=0&&n.splice(o,1)}this.saveExpandedState(n)}getExpandedIds(){let t=null;if(!window.localStorage)return[];const e=window.localStorage.getItem(this.expandedStateKey);if(e)try{t=JSON.parse(e)}catch{t=null}return t||(t=[],this.saveExpandedState(t)),t}saveExpandedState(t){window.localStorage&&window.localStorage.setItem(this.expandedStateKey,JSON.stringify(t))}getEntityId(t){return t.getAttribute("data-entity-id")||t.id}getParentId(t){return t?t.getAttribute("data-parent-id"):null}getSiblingId(t){if(!t)return null;const e=this.getEntityId(t);if(!e)return null;const n=parseInt(e,10);return Number.isNaN(n)?null:n}async onSortableChange(t){const e=t.item;if(!e)return!1;const n=this.getEntityId(e);if(!n)return!1;const s=parseInt(n,10);if(Number.isNaN(s))return!1;let o=this.getParentId(e.parentElement);o===null&&t.to&&(o=this.getParentId(t.to));let r=o?parseInt(o,10):null;if(Number.isNaN(r)&&(r=null),s===r)return(this.entityType==="tag"||this.entityType==="folder")&&alert(`You cannot move a ${this.entityType} inside itself!`),console.error(`You cannot move a ${this.entityType||"item"} inside itself!`),window.location.reload(),!1;const i={csrfToken:this.getAttribute("data-ajax-token")||window.RozierConfig.ajaxToken||"",id:s};this.entityType==="node"?typeof r=="number"&&Object.assign(i,{newParentId:r}):r&&(i.newParentId=r);const u=this.getSiblingId(e.nextElementSibling);if(u!==null)i.nextId=u;else{const a=this.getSiblingId(e.previousElementSibling);a!==null&&(i.prevId=a)}if(!this.positionRoute)return!1;try{const a=await fetch(this.positionRoute,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams(i)});if(!a.ok)throw a;const l=await a.json(),h=this.entityType==="node"?l.responseText||l.detail:l.responseText;window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:h,status:l.status}}))}catch(a){const l=await a.json();window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:l.error_message||l.detail,status:"danger"}}))}return!0}destroySortable(){this.sortables.length&&(this.sortables.forEach(t=>t.destroy()),this.sortables=[])}}export{S as default};
