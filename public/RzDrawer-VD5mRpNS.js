import{g as u}from"./main-BPrMlaF3.js";import{S as f}from"./sortable.core.esm-Bjnw44Mn.js";import{r as g}from"./rzCard-CW2rd_kK.js";import"./vue-BqDQd3Vv.js";import"./jquery-DmndgEMa.js";import"./rzButton-J_yTZFMr.js";import"./rzBadge-BmGDcOV7.js";function b({item:i,index:t,name:e,acceptEntity:s,onRemoveClick:n,onEditClick:l}){const o=i.isPdf||i.isImage||i.isVideo||i.isEmbed,h=[{iconClass:"rz-icon-ri--delete-bin-7-line",emphasis:"tertiary",color:"danger",attributes:{type:"button"},on:{click:()=>{n(i)}}}];if(i.editItem){const m=i.editItem+"?referer="+window.location.pathname;i.isImage&&!i.isEmbed&&!i.isVideo&&!i.isPdf?h.unshift({tag:"a",iconClass:"rz-icon-ri--equalizer-3-line",emphasis:"primary",attributes:{href:m},on:{click:c=>{c.preventDefault(),c.stopImmediatePropagation(),l(i)}}}):h.unshift({tag:"a",iconClass:"rz-icon-ri--edit-line",emphasis:"primary",attributes:{href:m}})}const d={tag:"li",buttonGroup:{buttons:h}};i.isImage&&(d.buttonGroupTop={gap:"sm",size:"sm",buttons:[{iconClass:"rz-icon-ri--zoom-in-line",emphasis:"primary",attributes:{type:"button"},on:{click:()=>{document.dispatchEvent(new CustomEvent("show-preview",{detail:{document:i}}))}}}]});let a="";i.isPrivate?a="rz-icon-ri--lock-2-line":((i.isImage&&i.thumbnail80||i.thumbnail?.url)&&(d.image={src:i.thumbnail80||i.thumbnail?.url||""}),i.isPdf?a="rz-icon-ri--file-pdf-2-line":i.isEmbed?i.embedPlatform==="vimeo"?a="rz-icon-ri--vimeo-fill":i.embedPlatform==="youtube"&&(a="rz-icon-ri--youtube-fill"):i.isVideo&&(a="rz-icon-ri--file-video-fill")),a&&(d.badge={iconClass:a,size:"md"}),s!=="document"&&(d.overtitle=i.classname,d.title=i.displayable);const r=g(d);r.dataset.id=i.id?i.id.toString():"",r.dataset.inputBaseName=`${e}[${t}]`;const p=document.createElement("input");if(p.type="hidden",p.name=`${e}[${t}]${o?"[document]":""}`,p.value=i.id.toString(),r.appendChild(p),i.isImage){const m=document.createElement("input");m.type="hidden",m.name=`${e}[${t}][hotspot]`,m.value=i.hotspot?JSON.stringify(i.hotspot):"null",r.appendChild(m);const c=document.createElement("input");c.type="hidden",c.name=`${e}[${t}][imageCropAlignment]`,c.value=i.imageCropAlignment||"",r.appendChild(c)}return r}const y="rz-drawer__item";class x extends HTMLElement{constructor(){super(),this.fileUploadIsVisible=!1,this.fileUpload=null,this.items=[],this.listElement=null,this.itemElements=new WeakMap,this.sortable=null,this.validationProxy=null,this.onCommand=this.onCommand.bind(this),this.onAddDrawerItem=this.onAddDrawerItem.bind(this),this.onFileUploadSuccess=this.onFileUploadSuccess.bind(this)}connectedCallback(){this.acceptEntity=this.getAttribute("accept-entity")||"",this.name=this.getAttribute("name")||"",this.sortableEnabled=this.hasAttribute("sortable"),this.initExplorer(),this.initCommands(),this.initItems(),this.initSortable(),this.initFileUpload(),this.initValidationProxy()}disconnectedCallback(){this.destroyExplorer(),this.destroyItems(),this.destroyCommands(),this.destroySortable(),this.destroyFileUpload(),this.destroyValidationProxy()}initCommands(){this.addEventListener("command",this.onCommand)}destroyCommands(){this.removeEventListener("command",this.onCommand)}onCommand(t){switch(t.command){case"--open-explorer":this.openExplorer();break;case"--toggle-file-upload":this.toggleFileUpload();break}}initFileUpload(){this.fileUpload=this.querySelector("rz-file-upload"),this.fileUpload&&this.fileUpload.addEventListener("success",this.onFileUploadSuccess)}destroyFileUpload(){this.fileUpload&&this.fileUpload.removeEventListener("success",this.onFileUploadSuccess)}initValidationProxy(){this.validationProxy=this.querySelector("[data-drawer-validation-proxy]")}destroyValidationProxy(){this.validationProxy=null}syncValidationProxyOptions(t){this.validationProxy&&(this.validationProxy.innerHTML="",t.forEach(e=>{const s=document.createElement("option");s.value=e.toString(),s.selected=!0,s.setAttribute("selected","true"),this.validationProxy?.appendChild(s)}))}updateValidationProxy(){if(!this.validationProxy)return;const t=this.items.map(e=>e?.id).filter(e=>typeof e=="number"||typeof e=="string");this.syncValidationProxyOptions(t)}onFileUploadSuccess(t){const e=t.detail.response.document;e&&this.appendItem(e)}showFileUpload(){this.fileUploadIsVisible||(this.fileUploadIsVisible=!0,this.fileUpload&&(this.fileUpload.removeAttribute("hidden"),this.updateFileUploadControls()))}hideFileUpload(){this.fileUploadIsVisible&&(this.fileUploadIsVisible=!1,this.fileUpload&&(this.fileUpload.setAttribute("hidden",""),this.updateFileUploadControls()))}updateFileUploadControls(){if(!this.fileUpload)return;document.querySelectorAll(`[aria-controls="${this.fileUpload.id}"]`).forEach(e=>{e.setAttribute("aria-expanded",this.fileUploadIsVisible?"true":"false")})}toggleFileUpload(){this.fileUploadIsVisible?this.hideFileUpload():this.showFileUpload()}initExplorer(){document.addEventListener("add-drawer-item",this.onAddDrawerItem)}destroyExplorer(){document.removeEventListener("add-drawer-item",this.onAddDrawerItem)}getFiltersFromAttributes(){const t=this.getAttribute("provider-class"),e=this.getAttribute("locale"),s=this.getAttribute("provider-options"),n=s?JSON.parse(decodeURIComponent(s)):null,l=this.getAttribute("data-nodetypes"),o=this.getAttribute("data-nodetypefield"),h=this.getAttribute("data-nodetypename");return{nodeTypes:l,nodeTypeField:o,providerClass:t,providerOptions:n,nodeTypeName:h,_locale:e}}openExplorer(){document.dispatchEvent(new CustomEvent("show-explorer",{detail:{id:this.getAttribute("id"),acceptEntity:this.getAttribute("accept-entity"),filters:this.getFiltersFromAttributes()}}))}onAddDrawerItem(t){const e=t.detail.drawerId||"";if(!e||e!==this.getAttribute("id"))return;const s=t.detail.item;s&&this.appendItem(s)}async initItems(){const t=JSON.parse(this.getAttribute("items")||"[]"),e=this.acceptEntity;if(this.listElement=this.querySelector("[data-list]"),!Array.isArray(t)||t.length===0||!e||!this.listElement)return;const s=t.map(o=>o&&typeof o=="object"&&"document"in o?o.document:o),n=this.getFiltersFromAttributes(),l=await u(e,s,n).catch(o=>{console.error("Error fetching drawer items",o)});if(l&&l.items){const o=document.createDocumentFragment();l.items.forEach((h,d)=>{const a={...h},r=t[d];r&&typeof r=="object"&&("hotspot"in r&&(a.hotspot=r.hotspot),"imageCropAlignment"in r&&(a.imageCropAlignment=r.imageCropAlignment)),this.items.push(a);const p=this.createItemElement(a,d);this.itemElements.set(a,p),o.appendChild(p)}),this.listElement.appendChild(o)}this.updateValidationProxy()}destroyItems(){this.itemElements=new WeakMap}createItemElement(t,e){const s=b({item:t,index:e,acceptEntity:this.acceptEntity,name:this.name,onRemoveClick:n=>{this.removeItem(n)},onEditClick:n=>{this.openImageEditDialog(n)}});return s.classList.add(y),s}appendItem(t){if(!this.listElement||this.itemElements.has(t))return;this.items.push(t);const e=this.items.length-1,s=this.createItemElement(t,e);this.itemElements.set(t,s),this.listElement.appendChild(s),this.updateValidationProxy(),this.dispatchLengthChange()}removeItem(t){const e=this.items.indexOf(t);if(e>-1){this.items.splice(e,1);const s=this.itemElements.get(t);s&&s.parentNode&&s.parentNode.removeChild(s),this.itemElements.delete(t),this.reindexItems(),this.updateValidationProxy(),this.dispatchLengthChange()}}reindexItems(){if(this.listElement)for(let t=0,e=this.listElement.children.length;t<e;t++){const s=this.listElement.children[t],n=s.querySelectorAll(`input[type="hidden"][name^="${this.name}["]`);s.dataset.inputBaseName=`${this.name}[${t}]`;for(let l=0;l<n.length;l++)n[l].name=n[l].name.replace(/\[\d+\]/,`[${t}]`)}}openImageEditDialog(t){const e=document.createElement("document-edit-dialog");if(this.listElement){const s=this.listElement.querySelector(`[data-id="${t.id?.toString()}"]`);if(s){const n=s.dataset.inputBaseName||"";n&&e.setAttribute("input-base-name",n)}}e.setAttribute("template-path",this.getAttribute("document-alignment-template-path")),e.setAttribute("title",t.classname),e.setAttribute("edit-url",t.editItem+"?referer="+window.location.pathname),e.setAttribute("open",""),t.isImage&&(e.setAttribute("image-path",t.editImageUrl),e.setAttribute("image-width",String(t.editImageWidth)),e.setAttribute("image-height",String(t.editImageHeight)),t.originalHotspot&&e.setAttribute("original-hotspot",JSON.stringify(t.originalHotspot))),document.body.appendChild(e)}dispatchLengthChange(){this.dispatchEvent(new CustomEvent("length-change",{detail:{length:this.items.length},bubbles:!0}))}initSortable(){!this.listElement||this.sortable||!this.sortableEnabled||(this.sortable=f.create(this.listElement,{animation:150,onEnd:()=>{this.reindexItems()}}))}destroySortable(){this.sortable&&(this.sortable.destroy(),this.sortable=null)}}export{x as RzDrawer};
