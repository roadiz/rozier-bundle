import{A as i,P as d}from"./Popover-BrqRB6W9.js";class c extends HTMLElement{constructor(){super(),this.popoverInstance=null,this.onCommand=this.onCommand.bind(this),this.onPopoverOpen=this.onPopoverOpen.bind(this)}static get observedAttributes(){return[...i]}attributeChangedCallback(){this.popoverInstance?.updateOptions()}get nodeId(){const e=this.getAttribute("data-node-id");return e?parseInt(e):null}get nodePathFetch(){return this.getAttribute("data-contextual-menu-path")}get editPositionPath(){return this.getAttribute("data-node-edit-position-path")}get duplicatePath(){return this.getAttribute("data-node-duplicate-path")}get pastePath(){return this.getAttribute("data-node-paste-path")}get statusPath(){return this.getAttribute("data-node-status-path")}get copiedTrans(){return this.getAttribute("data-node-copied-trans")}get copiedNodeId(){const e=window.sessionStorage.getItem("rozier_copied_node_id");return e?parseInt(e):null}get targetButton(){return this.querySelector("[popovertarget]")}get popoverElement(){return this.querySelector("[data-contextual-menu-popover]")}get isPopoverFetched(){return this.popoverElement?.getAttribute("data-popover-content-state")==="fetched"}connectedCallback(){if(!this.nodePathFetch){console.warn("NodeTreeContextualMenu: missing data-contextual-menu-path");return}if(!this.popoverElement){const e=document.createElement("div");e.id=this.targetButton?.getAttribute("popovertarget")||"",e.setAttribute("popover",""),e.setAttribute("data-popover-content-state","idle"),e.setAttribute("data-contextual-menu-popover",""),this.appendChild(e)}this.addEventListener("command",this.onCommand),this.popoverInstance=new d(this,{popoverElement:this.popoverElement,onOpen:this.onPopoverOpen})}disconnectedCallback(){this.popoverInstance?.destroy(),this.popoverInstance=null,this.removeEventListener("command",this.onCommand)}onPopoverOpen(){this.isPopoverFetched||this.replacePopoverContent()}async replacePopoverContent(){window.dispatchEvent(new CustomEvent("requestLoaderShow"));const e=await fetch(this.nodePathFetch,{headers:{"X-Requested-With":"XMLHttpRequest"}});this.popoverElement.innerHTML=await e.text(),this.popoverElement.setAttribute("data-popover-content-state","fetched"),this.popoverElement.querySelectorAll("button[command]").forEach(t=>{t.setAttribute("commandfor",this.id),(t.getAttribute("command")==="--paste-inside"||t.getAttribute("command")==="--paste-after")&&(Number.isInteger(this.copiedNodeId)?(t.removeAttribute("disabled"),t.setAttribute("title","Stored node id: "+this.copiedNodeId)):t.setAttribute("disabled","disabled"))}),window.dispatchEvent(new CustomEvent("requestLoaderHide"))}async onCommand(e){switch(e.preventDefault(),window.dispatchEvent(new CustomEvent("requestLoaderShow")),e.command){case"--duplicate":await this.duplicateNode();break;case"--copy":this.copyNode();break;case"--paste-inside":await this.pasteInsideNode();break;case"--paste-after":await this.pasteAfterNode();break;case"--update-status":await this.changeStatus(e);break;case"--move-first":await this.moveNodeToPosition("first",e);break;case"--move-last":await this.moveNodeToPosition("last",e);break}}async changeStatus(e){const t=e.source,s=t?.getAttribute("data-status"),o=t?.getAttribute("data-value");if(!(!s||!o))try{await this.postNodeUpdate(this.statusPath,{csrfToken:window.RozierConfig.ajaxToken,nodeId:this.nodeId,statusName:s,statusValue:o})}finally{this.popoverElement.setAttribute("data-popover-content-state","need-update"),await this.replacePopoverContent(),window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}copyNode(){window.sessionStorage.setItem("rozier_copied_node_id",this.nodeId.toString()),window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:this.copiedTrans||"Node copied to clipboard",status:"success"}})),window.dispatchEvent(new CustomEvent("requestLoaderHide"))}async pasteInsideNode(){await this.pasteNode("parentNodeId")}async pasteAfterNode(){await this.pasteNode("prevNodeId")}async pasteNode(e="parentNodeId"){if(!Number.isSafeInteger(this.copiedNodeId)||!Number.isSafeInteger(this.nodeId))return;const t={csrfToken:window.RozierConfig.ajaxToken,nodeId:this.copiedNodeId};t[e]=this.nodeId;try{await this.postNodeUpdate(this.pastePath,t),window.sessionStorage.removeItem("rozier_copied_node_id")}finally{window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}async duplicateNode(){if(Number.isSafeInteger(this.nodeId))try{await this.postNodeUpdate(this.duplicatePath,{csrfToken:window.RozierConfig.ajaxToken,nodeId:this.nodeId})}finally{window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}async moveNodeToPosition(e,t){if(!Number.isSafeInteger(this.nodeId))return;window.dispatchEvent(new CustomEvent("requestLoaderShow"));const s=t.currentTarget.closest(".nodetree-element"),o=parseInt(s.closest("ul")?.getAttribute("data-parent-node-id")||""),a={csrfToken:window.RozierConfig.ajaxToken,id:this.nodeId};typeof e<"u"&&e==="first"?Object.assign(a,{firstPosition:!0}):typeof e<"u"&&e==="last"&&Object.assign(a,{lastPosition:!0}),typeof o=="number"&&Object.assign(a,{newParentId:o});try{await this.postNodeUpdate(this.editPositionPath,a)}finally{window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}async postNodeUpdate(e,t){if(e)try{const s=await fetch(e,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams(Object.entries(t).reduce((o,[a,n])=>(o[a]=n===null?"":String(n),o),{}))});if(s.ok){const o=await s.json();return window.dispatchEvent(new CustomEvent("requestAllNodeTreeChange")),o}else{const o=await s.json();throw window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:o.error_message,status:"danger"}})),o}}catch(s){window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:s.detail||s.message||"postNodeUpdate: Unknown error",status:"danger"}}))}}}export{c as default};
