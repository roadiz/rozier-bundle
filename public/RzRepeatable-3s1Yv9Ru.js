class E extends HTMLElement{constructor(){super(),this.list=null,this.itemTemplate=null,this.itemClass="rz-repeatable__item",this.inputIndexPlaceholder="__name__",this.inputBaseName="source[key]",this.idBaseName="source_key",this.onCommand=this.onCommand.bind(this)}filterInnerNestedItems(e){return Array.from(this.querySelectorAll(e)).filter(s=>s.closest("rz-repeatable")===this)}moveItem(e,t){t===-1&&e.previousElementSibling?e.previousElementSibling.before(e):t===1&&e.nextElementSibling&&e.nextElementSibling.after(e),this.updateAllInputAttributes(),this.updateMoveButtonsState()}removeItem(e){e?.remove(),!e?.nextElementSibling||(this.updateAllInputAttributes(),this.updateMoveButtonsState())}addItem(e){const t=this.itemTemplate.content.firstElementChild;if(!t)return;const s=document.importNode(t,!0);if(e){const a=this.list?.children.item(parseInt(e,10));this.list?.insertBefore(s,a||null)}else this.list?.appendChild(s);this.updateAllInputAttributes(),this.updateMoveButtonsState()}onCommand(e){const t=e.source,s=t.closest(`.${this.itemClass}`);switch(e.command){case"--add":this.addItem(t.getAttribute("data-insert-index"));break;case"--remove":this.removeItem(s);break;case"--move-up":this.moveItem(s,-1);break;case"--move-down":this.moveItem(s,1);break}}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}get itemElements(){return Array.from(this.list?.querySelectorAll(`.${this.itemClass}`)||[]).filter(e=>e.closest("rz-repeatable")===this)}updateAllInputAttributes(){const e=this.list?.querySelectorAll(`.${this.itemClass}`);if(!e||!e.length)return;const t=this.escapeRegExp(this.inputIndexPlaceholder),s=this.escapeRegExp(this.inputBaseName),a=new RegExp(`^(${s})\\[(?<id>${t}|\\d+)\\](.*)$`),n=this.escapeRegExp(this.idBaseName),b=new RegExp(`^(${n})(?<id>_{1,3}${t}_{1,3}|_{1,3}\\d+_{1,3})(.*)$`);e.forEach((o,m)=>{Array.from(o.querySelectorAll(`input[name^="${this.inputBaseName}"], select[name^="${this.inputBaseName}"], textarea[name^="${this.inputBaseName}"]`)).filter(i=>i.closest("rz-repeatable")===this).forEach(i=>{const l=i.getAttribute("name"),r=l?.match(a);if(!r?.groups?.id){console.warn("Can't extract id/index from input name",l);return}const f=`${r[1]}[${m}]${r[3]}`;i.setAttribute("name",f);const u=i.getAttribute("id"),c=o.querySelector(`label[for="${u}"]`),d=u?.match(b);if(c){const h=[d?.[1],m,d?.[3]].filter(p=>!!p||typeof p=="number").join("_");i.setAttribute("id",h),c.setAttribute("for",h)}})})}updateMoveButtonsState(){Array.from(this.querySelectorAll('button[command="--move-up"], button[command="--move-down"]')).filter(t=>t.closest("rz-repeatable")===this).forEach(t=>{const s=t.closest(`.${this.itemClass}`);if(!s)return;const a=!s.previousElementSibling,n=!s.nextElementSibling;t.getAttribute("command")==="--move-up"&&a||t.getAttribute("command")==="--move-down"&&n?t.setAttribute("disabled","true"):t.removeAttribute("disabled")})}connectedCallback(){this.list=this.querySelector("[data-list]"),this.itemTemplate=this.querySelector("template[data-item]"),this.inputIndexPlaceholder=this.getAttribute("input-index-placeholder")||"",this.inputBaseName=this.getAttribute("input-base-name")||"",this.idBaseName=this.getAttribute("id-base-name")||"",this.hasAttribute("item-class")&&(this.itemClass=this.getAttribute("item-class")),this.updateMoveButtonsState(),this.addEventListener("command",this.onCommand)}destroyCommands(){this.removeEventListener("command",this.onCommand)}}export{E as RzRepeatable};
