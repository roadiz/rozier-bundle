import{R as l}from"./RoadizElement-XU473doh.js";import{f as c,a as u,s as w}from"./main-BPrMlaF3.js";import"./vue-BqDQd3Vv.js";import"./jquery-DmndgEMa.js";class A extends l{constructor(){super(),this.onPageShowEnd=this.handlePageShowEnd.bind(this),this.onAllNodeTreeChange=this.handleAllNodeTreeChange.bind(this),this.onMainTreeRefresh=this.handleMainTreeRefresh.bind(this),this.onBindMainTreesRequest=this.handleBindMainTreesRequest.bind(this),this.onAjaxLinkBindRequest=this.handleAjaxLinkBindRequest.bind(this),this.onMessagesRefresh=this.handleMessagesRefresh.bind(this),this.onLangButtonClick=this.handleLangButtonClick.bind(this),this.onMainTreeContextMenu=this.maintreeElementNameRightClick.bind(this)}get rozier(){return window.Rozier}connectedCallback(){this.listen(this,"click",this.onLangButtonClick),this.refreshAsideMainTree(),window.addEventListener("pageshowend",this.onPageShowEnd),window.addEventListener("requestAllNodeTreeChange",this.onAllNodeTreeChange),window.addEventListener("requestAllNodeTreeRefresh",this.onAllNodeTreeChange),window.addEventListener("requestMainTreeRefresh",this.onMainTreeRefresh),window.addEventListener("requestBindMainTrees",this.onBindMainTreesRequest),window.addEventListener("requestAjaxLinkBind",this.onAjaxLinkBindRequest),window.addEventListener("requestMessagesRefresh",this.onMessagesRefresh)}disconnectedCallback(){super.disconnectedCallback(),window.removeEventListener("pageshowend",this.onPageShowEnd),window.removeEventListener("requestAllNodeTreeChange",this.onAllNodeTreeChange),window.removeEventListener("requestAllNodeTreeRefresh",this.onAllNodeTreeChange),window.removeEventListener("requestMainTreeRefresh",this.onMainTreeRefresh),window.removeEventListener("requestBindMainTrees",this.onBindMainTreesRequest),window.removeEventListener("requestAjaxLinkBind",this.onAjaxLinkBindRequest),window.removeEventListener("requestMessagesRefresh",this.onMessagesRefresh)}handlePageShowEnd(){this.refreshAsideMainTree()}handleAllNodeTreeChange(){this.refreshAllNodeTrees(),window.dispatchEvent(new CustomEvent("requestMessagesRefresh"))}handleMainTreeRefresh(){this.refreshAsideMainTree()}handleMessagesRefresh(){this.rozier?.getMessages?.()}handleBindMainTreesRequest(){this.bindMainTrees()}handleAjaxLinkBindRequest(){this.rozier?.lazyload?.bindAjaxLink?.()}get treeContainer(){return this.querySelector(".rz-aside__body")}handleLangButtonClick(t){const e=t.target?.closest("button");if(!e||!this.contains(e))return;const n=e.getAttribute("data-translation-id"),r=n?parseInt(n,10):void 0;if(e.closest('[data-tree-type="node"]')){window.dispatchEvent(new CustomEvent("requestLoaderShow")),this.refreshMainNodeTree(r);return}if(e.closest('[data-tree-type="folder"]')){window.dispatchEvent(new CustomEvent("requestLoaderShow")),this.refreshMainFolderTree(r);return}e.closest('[data-tree-type="tag"]')&&(window.dispatchEvent(new CustomEvent("requestLoaderShow")),this.refreshMainTagTree(r))}bindMainTrees(){this.querySelectorAll(".tree-element-name").forEach(e=>{e.removeEventListener("contextmenu",this.onMainTreeContextMenu),e.addEventListener("contextmenu",this.onMainTreeContextMenu)})}maintreeElementNameRightClick(t){t.preventDefault(),document.querySelectorAll(".tree-contextualmenu").forEach(r=>{r.classList.contains("uk-open")&&r.classList.remove("uk-open")});const n=t.currentTarget?.parentElement?.querySelector(".tree-contextualmenu");return n&&(n.classList.contains("uk-open")?n.classList.remove("uk-open"):n.classList.add("uk-open")),!1}refreshAllNodeTrees(t){const e=[];return e.push(this.refreshMainNodeTree(t)),this.rozier?.lazyload?.stackNodeTrees?.treeAvailable?.()&&e.push(this.rozier.lazyload.stackNodeTrees.refreshNodeTree()),Promise.all(e)}async refreshAsideTreeContent(t=""){if(!t){console.warn("No treeHTML provided to refreshAsideTreeContent");return}const e=this.treeContainer;if(!e){console.warn("No tree container found to refreshAsideTreeContent");return}const n=e.querySelector(".rz-tree-wrapper"),r=document.createElement("div");r.innerHTML=t;const a=r.querySelector(".rz-tree-wrapper");await c(e),a&&e.appendChild(a),n&&n.remove(),await u(e),this.bindMainTrees(),this.rozier?.resize?.(),this.rozier?.lazyload?.bindAjaxLink?.()}async refreshMainTree(t,e={}){const n=this.treeContainer;if(!n)return;const r=n.querySelector(".rz-tree-wrapper");if(r&&!e?.translationId){const i=r.getAttribute("data-translation-id");i&&(e.translationId=i)}const a=new URLSearchParams({_token:window.RozierConfig.ajaxToken,_action:"requestMainTree",url:window.location.pathname,...e}),d=t||window.RozierConfig.routes?.treeAjaxGateway;if(!d)return;const o=await fetch(`${d}?${a.toString()}`,{method:"GET",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(!o.ok)throw o;const s=await o.json(),h=s?.nodeTree||s?.tagTree||s?.folderTree||s?.tree;if(s&&typeof h<"u"){const i=`${s.tree_type||"node"}-tree`+(e?.translationId?`-${e?.translationId}`:"-main-locale");if(i===n.getAttribute("data-tree-id"))return;this.refreshAsideTreeContent(h),n.setAttribute("data-tree-id",i)}}async refreshAsideMainTree(t=null,e={}){try{await this.refreshMainTree(t,e)}catch{console.debug("[RzAside.refreshAsideMainTree] Retrying in 3 seconds"),await w(3e3),await this.refreshMainTree(t,e)}window.dispatchEvent(new CustomEvent("requestLoaderHide"))}async refreshMainNodeTree(t=void 0){await this.refreshAsideMainTree(window.RozierConfig.routes?.nodesTreeAjax||null,{translationId:t})}async refreshMainTagTree(t=void 0){await this.refreshAsideMainTree(window.RozierConfig.routes?.tagsTreeAjax||null,{translationId:t})}async refreshMainFolderTree(t=void 0){await this.refreshAsideMainTree(window.RozierConfig.routes?.foldersTreeAjax||null,{translationId:t})}}export{A as default};
