const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["leaflet-src-B4LCaRnj.js","jquery-DmndgEMa.js"])))=>i.map(i=>d[i]);
import{_ as h}from"./main-C8p0Nwvp.js";import"./vue-BqDQd3Vv.js";import"./jquery-DmndgEMa.js";async function c(l){const t="https://nominatim.openstreetmap.org/search?"+new URLSearchParams({format:"json",q:l}).toString(),i=await(await fetch(t,{method:"GET",headers:{Accept:"application/json"},credentials:"omit"})).json();return i&&i[0]?i[0]:null}const m="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAeCAYAAAAo5+5WAAAACXBIWXMAAAsSAAALEgHS3X78AAAD/klEQVRIDZVWTWhcVRT+7pskM29+Xl6SaSpdOFGQQlps6UIUrMRNEbvVVVHcGKtVtKEEBf9QoRJEFLFidCG6bJZWrJsG24UbS6uJtrTFdGwlyUySmcz0vUySeU/Oue++30mqBx5z7/n57rnnnp8RruuiE4kvx/fCar2NtbXHsekUI8IurYpM5hyy6ffcFyZmEsZkHwcW3741iKX6d2jYh6CngaF7gKIZtarWgLl5wG4BBf0nDPQ+4z77/uKWwGJyfASLtR8ghI59DwClnQDJw4cLEfzeXAAuXyO5jUHzSXd0YjoB7IPmdR2P7QdSmtTYIlT+AW0HOH8JaNg2dpgPqdBovuJy4xsUdB0H90lQAnTI2xCQAiNyvJuQ7sH9YNuVxvdKzMDi1Ik30Noo4cBuoCsVBdQEUL8DVOtAdVWu1QGudwCBk21ro8RY9L6sUG+M4d6dgJGLXr3dBi7MAEurITAXGDCAR/YCqVTAI1vCmK+OATipcWzX20UMlwIvSHGzDfx8CVi9s4TBvqfdd74W9NGaeSQjHTd0u+EhEBZharDXjyCbBvRMkAHk3fVbQNO2UTRH3Jc+mlKX4HXRHGEZ6ZCusqP0JCx7/Yh8PNqETyaq1ICcfqZTATAvp5/hfPaZ3k0JK5IVvoKHbq3RQ9YSckXbyRLACpRPzlAMzYSFIpIpL+NF5ANbraTXO0ygaR3mnhEj5jWtw6wTLyAPS0NP91neUN2HC+D+XUA+q6OyMi1OnXhKsXldWZlmGen4AiExCLin+yyXtPhg1MLwkI77dgGOE3hB5frLLLBMeaxK3AH6DeDhPUHZE6imAX/9A/wxZ7tvTmZlgWTT51FeOBTxgLDJ8NEHgXoT2HQknyqzNxdUp7okVWh5QWL5Mc7rJ2XZxiqMjMnrQg7oL8ivkJW88IORTaUuy52wFDC3Oz09iytzyWYTPsTp0EI5DAJsq6dnVesM0i2vv8seU7MBkuCdSKmQHfUTwlBnRhr9xLEZdKf2YOSAbEDOFr3YfzAh3+HcRWCjPeuOf+6nZrRAzNzLqFvAjduB4VYkPHDSXbWkbYgiwBwfIzuFK2Xpbad4w8sA4lNq/lmmB50Kj6Wkx0TF3mMQ7hIuXpW5qYnonFN7CsGvV8G6ZBM/O87gadtnHMX8MnCrEoAzYKgY/q6AdfqMo/EJ3REYqucaudP47To1eg/c+8jThgX8foOmxulwrw5T4n9FRPjhi3PI9JR4wHZ5Y4imxoXL1Mxvuq9/MZQw2s5jn/oLz/GkIO9Snre0plFPsm1oW2B+6QHjOMqLMqb00XrAOB7Pgv8VCl/ps7FJ1JrP88bMf+W+8vHoXW3+CzArfvraj3yLVz954q7KAP4FsFfcPBQDhqkAAAAASUVORK5CYII=",d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAWCAYAAAA1vze2AAAACXBIWXMAAAsSAAALEgHS3X78AAABZElEQVRIibWVv07DMBDGPyMLFpjiBUQkJrrABA/ABBPvwDvyAkyw0Cld6BTJEl2ciU5ZjK6cUxTbsdO0nxRFdU73u3++CmstDi25q39RqjMA9BwDKACs6Nxq8+3Z5mbCTq8AnAO4YOchtQBqAO9WmzYLIkpFDm8YMEYNgFcCRcvFzu848l1EJZwBqDyIKBWV4Z6jn6pNSWUPQPQnAKcR567eP/x7NmDr7LcQBjxHGtpyI5e9oCoAL571VnUHSQC6Bnpf/jKJaWG12WR8xAYPEQDpLQQQpbrmwQiJAvt055KNi4Ch00nPOY3y7cDUeZkLXBaPGXeg4b7EHDvVocwl396UhjJ1mltt5t4pQ2K9yNWao/d21n/IFC2owaHB2AckGf0UCEVcxWofk+T/gZwlSJPz4S7YWEiTgKx4crJKExJBviIbd81NXXpfxkKsNo0oFTl023RvzjsIv2mb0h4a3dSkAPwCJdSH4GnrpMEAAAAASUVORK5CYII=";class A extends HTMLElement{constructor(){super(),this.defaultLocation={lat:45.769785,lng:4.833967,zoom:14},this.leaflet=null,this.map=null,this.markers=[],this.resizeObserver=null,this.mapContainer=null,this.idSeed=Date.now().toString(36),this.idCounter=0,this.dataset.initialized="false",this.onTargetMarker=this.onTargetMarker.bind(this),this.onSearchChange=this.onSearchChange.bind(this),this.onDelete=this.onDelete.bind(this),this.onMapClick=this.onMapClick.bind(this),this.onCommand=this.onCommand.bind(this)}get fieldWrapper(){const t=this.getAttribute("wrapper-id");return this.closest(`#${t}`)}get searchInput(){const t=this.getAttribute("search-input-id");return t?this.fieldWrapper?.querySelector(`input#${t}`):null}get textarea(){return this.querySelector("textarea")}get isMultiple(){const t=(this.getAttribute("multiple")||"").toLowerCase();return t==="true"||t==="1"||t==="yes"}connectedCallback(){this.dataset.initialized!=="true"&&h(()=>import("./leaflet-src-B4LCaRnj.js").then(t=>t.l),__vite__mapDeps([0,1])).then(t=>{this.leaflet=t,this.init(),this.dataset.initialized="true"}).catch(t=>{console.error("Failed to load Leaflet dynamically",t)})}disconnectedCallback(){this.destroy()}get defaultOptions(){const t=window.RozierConfig?.defaultMapLocation||this.defaultLocation,e=new this.leaflet.LatLng(t.lat,t.lng,t?.zoom??t?.alt),i=t.zoom||t?.alt||this.defaultLocation.zoom;return{center:e,zoom:i}}init(){if(!this.textarea){console.error("<rz-geotag> cannot find textarea");return}this.mapContainer=document.createElement("div"),this.mapContainer.className="rz-geotag__map",this.appendChild(this.mapContainer);const{center:t,zoom:e}=this.defaultOptions;this.map=this.createMap(this.mapContainer,{center:t,zoom:e}),this.initMarkersFromTextarea(),this.addEventListener("command",this.onCommand),this.searchInput?.addEventListener("change",this.onSearchChange),this.map?.on("click",this.onMapClick),this.resizeObserver=new ResizeObserver(()=>{if(this.map){if(this.map.invalidateSize({animate:!1,pan:!1}),this.markers.length>1){const i=new this.leaflet.LatLngBounds(this.markers.map(a=>a.getLatLng()));this.map.fitBounds(i,{animate:!1})}else if(this.markers.length===1){const i=this.markers[0].getLatLng();this.map.panTo(i,{animate:!1})}}}),this.resizeObserver.observe(this)}createMap(t,e){if(!t)throw new Error("Missing map container");const i=new this.leaflet.Map(t).setView(e.center,e.zoom),a=window.RozierConfig?.leafletMapTileUrl||"OpenStreetMap",s=new this.leaflet.TileLayer(a,{attribution:"Â© OpenStreetMap contributors",maxZoom:18});return i.addLayer(s),i}initMarkersFromTextarea(){const t=this.textarea?.value?.trim();if(!t)return;const e=JSON.parse(t),i=[];e.type==="FeatureCollection"&&Array.isArray(e.features)?i.push(...e.features):e.type==="Feature"&&i.push(e),i.forEach((a,s)=>{const n=this.itemDetailList?.children.item(s),r=this.createMarker(a,{itemDetailId:n?.id});this.markers.push(r),this.bindMarker(r)})}formatLatLngLabel(t){return`${t.lat.toFixed(5)}, ${t.lng.toFixed(5)}`}addAndSyncMarker(t){if(this.isMultiple)this.markers.push(t);else{const i=this.markers.pop();i&&i.removeFrom(this.map),this.markers=[t]}this.bindMarker(t),this.updateItemDetailList(),this.syncTextareaData();const e=t.getLatLng();e&&this.map.flyTo(e,e.alt)}createMarker(t,e){if(!this.map)return;let i=null,a=e?.name||"";if(t instanceof this.leaflet.LatLng)i=t;else if("display_name"in t)i=new this.leaflet.LatLng(parseFloat(t.lat),parseFloat(t.lon)),a=t.display_name;else if("lat"in t&&"lng"in t)i=new this.leaflet.LatLng(t.lat,t.lng,t?.zoom??t?.alt);else if("type"in t&&t.type==="Feature"){const r=t.properties?.zoom,o=typeof r=="string"?parseInt(r,10):r??7;i=new this.leaflet.LatLng(t.geometry.coordinates[1],t.geometry.coordinates[0],o),a=t.properties?.name||""}const s=new this.leaflet.Marker(i,{icon:new this.leaflet.Icon({iconUrl:m,shadowUrl:d,iconSize:[22,30],shadowSize:[25,22],iconAnchor:[11,30],shadowAnchor:[2,22]}),draggable:!0}).addTo(this.map),n=s.toGeoJSON();return s.feature={...n,properties:{...n.properties,...e||{},name:a||this.formatLatLngLabel(i),itemDetailId:e?.itemDetailId||this.generateItemDetailId()}},s}onMapClick(t){if(!this.map)return;const e=this.createMarker(t.latlng);this.addAndSyncMarker(e)}onCommand(t){switch(t.command){case"--search-location":{this.onSearchChange();break}case"--delete-marker":this.onDelete(t);break;case"--delete-all-marker":this.onDeleteAll(t);break;case"--target-marker":this.onTargetMarker(t);break}}onTargetMarker(t){const e=t.source.getAttribute("data-item-detail-id"),i=this.markers.findIndex(n=>n.toGeoJSON()?.properties?.itemDetailId===e),a=this.markers[i],s=a.getLatLng();!a||!s||this.map.flyTo(s,this.map.getZoom())}setLoadingOnSearchBtn(t){const e=this.fieldWrapper?.querySelector('button[command="--search-location"]');e&&(t?e.classList.add("rz-button--loading"):e.classList.remove("rz-button--loading"))}async onSearchChange(){const t=this.searchInput?.value;if(!t?.trim().length)return;this.setLoadingOnSearchBtn(!0);const e=await c(t),{lat:i,lon:a}=e||{};if(this.setLoadingOnSearchBtn(!1),!e||!i||!a){this.searchInput?.classList.add("rz-input--error"),this.searchInput?.setCustomValidity("Place not found");return}else this.searchInput?.classList.remove("rz-input--error"),this.searchInput?.setCustomValidity("");const s=this.createMarker(e);this.addAndSyncMarker(s)}onDeleteAll(t){t.preventDefault(),this.map&&this.markers.forEach(e=>e.removeFrom(this.map)),this.searchInput?.value&&(this.searchInput.value=""),this.textarea&&(this.textarea.value=""),this.markers=[],this.updateItemDetailList()}onDelete(t){t.preventDefault();let e=-1;if(this.isMultiple){const i=t.source.getAttribute("data-item-detail-id");e=this.markers.findIndex(a=>a.feature?.properties?.itemDetailId===i)}else e=0,this.searchInput&&(this.searchInput.value="");if(e===-1){console.warn("Pin not found for deletion");return}this.markers[e].removeFrom(this.map),this.markers.splice(e,1),this.syncTextareaData(),this.updateItemDetailList()}bindMarker(t){t.on("dragend",()=>{if(!this.map)return;const e=t.getLatLng();this.map.panTo(e),this.syncTextareaData()})}syncTextareaData(){if(!this.textarea||!this.map)return;const t=this.markers.map(e=>e.toGeoJSON());t.length?this.isMultiple?this.textarea.value=JSON.stringify({type:"FeatureCollection",features:t}):this.textarea.value=JSON.stringify(t[0]):this.textarea.value=""}get itemDetailList(){return this.querySelector("[data-item-detail-list]")}get itemDetailSkeleton(){return this.fieldWrapper.querySelector("template[data-item-detail]")?.content?.firstElementChild}generateItemDetailId(){const t=this.getAttribute("item-detail-id-prefix")||"";return this.idCounter+=1,`${t}${this.idSeed}-${this.idCounter}`}updateItemDetailList(){const t=this.itemDetailSkeleton;!this.itemDetailList||!this.isMultiple||!t||(this.itemDetailList.innerHTML="",this.markers.forEach(e=>{const i=this.getItemDetail(e);this.itemDetailList.appendChild(i)}))}getItemDetail(t){const e=document.importNode(this.itemDetailSkeleton,!0),i=t.toGeoJSON(),a=i.properties?.itemDetailId;e.id=a;const s=e.querySelector("[data-item-detail-name]");if(s){const o=i.properties?.name||"";s.setAttribute("title",o),s.textContent=o}const n=e.querySelector("[data-item-detail-content]");n&&(n.textContent=this.formatLatLngLabel(t.getLatLng()));const r=e.querySelectorAll(".rz-geotag__item__button[data-item-detail-id]");return r.length&&r.forEach(o=>{o.setAttribute("commandfor",this.id),o.setAttribute("data-item-detail-id",a)}),e}destroy(){this.resizeObserver?.disconnect(),this.map?.off(),this.markers.forEach(t=>t.off()),this.searchInput?.removeEventListener("change",this.onSearchChange),this.removeEventListener("command",this.onCommand)}}export{A as default};
